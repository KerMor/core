classdef BaseApprox < dscomponents.ACoreFun
    %BASEAPPROX Abstract base class for all core function approximations
    %
    %   In the approximation context, the triple of x,t and mu is put
    %   together to a column vector when evaluated. This central class
    %   manages the combination/splitting process, no other subclass should
    %   (have to) know about the actual combination choice.
    %   See  evaluate and splitTripleVect for details.
    %
    % @author Daniel Wirtz @date 11.03.2010
    
    %     properties(SetAccess=private, GetAccess=protected)
    %         % The system's full dimension for readonly-use in subclasses.
    %         xDim;
    %     end
    
    methods
           
        function approximateCoreFun(this, model)
            ps = model.Data.ParamSamples;
            xi = model.Data.PlainSnapshotArray;
            
            num_samples = max(1,this.Data.SampleCount);
            num_inputs = max(1,this.System.InputCount);
            numPSamples = size(model.Data.Snapshots,3);
            numInSamples = size(model.Data.Snapshots,4);
            
            % Repeat times vector as often as different param/input combinations exist
            ti = repmat(model.Times,1,numPSamples*numInSamples);
            
            % Repeat ParamSamples for each time, then later the result for
            % each input. Leave [] if no params are given.
            mui = [];
            if (model.Data.SampleCount > 0)
                idx = repmat(...
                    reshape(...
                    repmat(1:size(ps,2),length(model.Times),1),...
                    1,[]),...
                    1,numInSamples...
                    );
                mui = model.Data.ParamSamples(:,idx);
            end
            
            % Call template method
            this.gen_approximation_data(xi, ti, mui, model.Data.fValues(:,:));
        end
    end
    
    methods(Abstract, Access=protected)
        % Computes the approximation according to the concrete
        % approximation strategy.
        %
        % Template method.
        %
        % Parameters:
        % xi: The state variable snapshots as column vectors, each row
        % representing each system dimension.
        % fxi: The core functions' values at the snapshots xi.
        gen_approximation_data(xi, ti, mui, fxi);
        
    end
    
    methods(Static)
        function res = testApproxProjections
            a{1} = approx.CompWiseInt;
            a{2} = approx.CompWiseSVR;
            a{3} = approx.CompWiseLS;
            
            b = cell(length(a),0);
            
            ts = testing.testsettings;
            samples = 30;
            x = rand(ts.testdim, samples);
            fx = ts.fnlin(x,repmat(1:samples,ts.testdim,1));
            
            model = models.BaseFullModel;
            model.Data.Snapshots = x;
            r = spacereduction.PODReducer;
            v = r.generateReducedSpace(model);
            
            res = true;
            for idx=1:length(a)
                try
                    app = a{idx};
                    mc = metaclass(app);
                    name = mc.Name;
                    cprintf(testing.MUnit.GreenCol,['Testing ' name '...']);
                    app.gen_approximation_data(x,fx);
                    b{idx} = app.project(v);
                    
                    ifxfull = app.evaluate_approximation(x);
                    ifxred = v * b{idx}.evaluate_approximation(v' * x);
                    figure(idx+20);
                    plot(1:ts.testdim,sum(abs(ifxfull-ifxred),2));
                    title(name);
                    xlabel('dimension');
                    ylabel('error');
                catch ME
                    res = false;
                    disp(getReport(ME));
                end
            end
        end
    end
    
end

